<!doctype html><meta charset="utf-8">
<title>Elvora</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="/manifest.webmanifest">
<link rel="stylesheet" href="/styles.css">
<meta name="theme-color" content="#0b0f14">
<body>
  <main class="wrap">
    <h1 id="title">Elvora</h1>
    <p id="prompt">Scan the expiry date</p>
    <form id="lookup">
      <input id="code" inputmode="numeric" pattern="[0-9]{8,14}" placeholder="EAN/QR..." required>
      <button type="submit">OK</button>
    </form>
    <section id="result" aria-live="polite"></section>
    <canvas id="ocrCanvas" style="display:none"></canvas>
  </main>
  <script type="module">
    import { t } from "/app/i18n.js";
    import { speak } from "/app/voice.js";
    import { ocrDate } from "/app/ocr.js";
    import "/app/command-palette.js";

    document.getElementById("prompt").textContent = t("scan_date");
    if ("serviceWorker" in navigator) addEventListener("load", () => navigator.serviceWorker.register("/sw.js"));

    const form = document.getElementById("lookup");
    const codeEl = document.getElementById("code");
    const out = document.getElementById("result");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const code = codeEl.value.trim();
      if (!code) return;
      out.textContent = "…";
      try {
        const res = await fetch(`/api/products?code=${encodeURIComponent(code)}`, { cache: "no-store" });
        const j = await res.json();
        const name = j?.product?.name || t("unknown");
        out.textContent = `${t("name")}: ${name}`;
        speak(name);
        // Simulacija OCR-a na postojećoj slici (ovdje može ići stream iz kamere)
        // const img = document.querySelector("#someVideoFrame");
        // const { norm } = await ocrDate(img);
        // if (norm) out.insertAdjacentText("beforeend", ` | ${t("expiry")}: ${norm}`);
        fetch("/api/scanlog", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ code, ts: Date.now(), source: j?.source }) }).catch(()=>{});
      } catch { out.textContent = "Greška na mreži."; }
    });
  </script>
</body>
